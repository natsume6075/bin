#!/usr/bin/bash

<< DISCRIPTIONS
このスクリプトでは、adb で以下のログが取れる。
- screen capture
- screen record
- logcat
- packet capture (tcpdump)
screen capture は、実行後に Enter を押すたびに取れる。
それ以外は、実行から quit を入力するまで取れる。
つまり、開始前のログは取らない。開始前を含めて取得したい場合は、他の方法で。

ファイル名は、開始時の日付時刻になる。引数でその後ろに文字列を追加できる。

パスの通っている adb 以外を使いたい場合は、エイリアスを張る。(例えば choocolatey でインストールしているなら以下のようになる。)
alias adb='/mnt/c/ProgramData/chocolatey/bin/adb.exe'

Maintainer:       Atsuyuki Natsume
Latest Revision:  2022-03-23
DISCRIPTIONS


alias adb='/mnt/c/ProgramData/chocolatey/bin/adb.exe'

set -eu
shopt -s expand_aliases

# set temporary file location in local environment.
tmp_dir=/sdcard

# set $out_filename
if [ $# = 0 ] ; then
    out_filename=`date '+%Y%m%d%H%M%S'`
elif [ $# = 1 ]; then
    out_filename=`date '+%Y%m%d%H%M%S'`_$1
else
    echo -e "Too many arguments! You should use as following.\nadb_alllog [output_filename(directory path is acceptable)]"
    exit
fi


# TODO これは attach は不適。なにで接続確認しようかな？
# attach できてないならここで終了。
# adb attach

# ルートが取れるか否かで分岐。取れないなら pcap はできない。
set +e
adb root
Rooted=$?
set -e

echo -e ""

if [ $Rooted = 0 ] ; then
    adb shell tcpdump -s 0 -i eth0 -w $tmp_dir/tmp.pcap &
    PID_tcpdump=$!
    echo -e "Start getting packet capture.\n"
fi

adb logcat -f $tmp_dir/tmp.logcat &
PID_logcat=$!
echo -e "Start getting logcat.\n"

# TODO なぜか screenrecord はうまくいかない。原因不明。
# adb shell screenrecord $tmp_dir/tmp.mp4 &
# PID_screenrecord=$!
# echo -e "Start screen recording.\n"
# ps | grep adb


# wait user's input. 'quit'=>stop loggin. ''=>take screen capture.
i=1
while true
do
    read -p "Press [Enter] to take screen capture. Input quit[Enter] to stop logging." input
    if [ "$input" = '' ] ; then
        adb shell screencap -p $tmp_dir/tmp.png
        adb pull $tmp_dir/tmp.png $out_filename\_$i.png
        adb shell rm $tmp_dir/tmp.png
        echo -e "Save screen capture as $out_filename""_$i.png\n"
        i=$((i+=1))
    elif [ "$input" = 'quit' ] ; then
        break 1
    else
        echo -e "Invalid input.\n"
    fi
done


if [ $Rooted = 0 ] ; then
    kill $PID_tcpdump
fi
kill $PID_logcat
# kill $PID_screenrecord


echo -e "Logging is terminated...\n"
sleep 3


# For each element of process stack, rename temporary output files and move them to the host.

if [ $Rooted = 0 ] ; then
    adb pull $tmp_dir/tmp.pcap $out_filename.pcap
    adb shell rm $tmp_dir/tmp.pcap
    echo -e "Save packet capture as $out_filename.pcap\n"
fi
# TODO とは
#
# The capture file appears to be damaged or corrupt.
# (pcap: File has 1648535296-byte packet, bigger than maximum of 262144)
#
# The capture file appears to have been cut short in the middle of a packet.
#
# https://musclehunter.blogspot.com/2013/05/tcpdumpwireshark.html
#

adb pull $tmp_dir/tmp.logcat $out_filename.logcat
adb shell rm $tmp_dir/tmp.logcat
echo -e "Save logcat as $out_filename.logcat\n"

# adb pull $tmp_dir/tmp.mp4 $out_filename.mp4
# adb shell rm $tmp_dir/tmp.mp4
# echo -e "Save screen record as $out_filename.mp4\n"

